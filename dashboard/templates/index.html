<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loot Logger Dashboard</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7e22ce',
                        },
                        dark: {
                            bg: '#09090b',
                            card: '#0f0f12',
                            elevated: '#18181b',
                            border: '#27272a',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/splash.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/table.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    
    <!-- Alpine.js cloak style -->
    <style>[x-cloak] { display: none !important; }</style>
</head>

<body>
    <!-- ==========================================
         SPLASH SCREEN
         ========================================== -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
        </div>
        
        <h1 class="splash-title">Loot Logger</h1>
        <p class="splash-subtitle">Dashboard</p>
        
        <div class="splash-progress">
            <div class="splash-progress-bar"></div>
        </div>
        
        <div class="splash-version">
            <span class="splash-version-dot"></span>
            <span>v3.3 • by Kazz</span>
        </div>
    </div>

    <!-- ==========================================
         MAIN APPLICATION
         ========================================== -->
    <div class="app-container" id="app" x-data="dashboard()">
        
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <i data-lucide="box"></i>
                    </div>
                    <div class="sidebar-logo-text">
                        <h1>Loot Logger</h1>
                        <span>Dashboard v3.3</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-content">
                <!-- Search -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Busca</div>
                    <div class="search-wrapper">
                        <i data-lucide="search"></i>
                        <input type="text" 
                               placeholder="Buscar itens..." 
                               x-model="filters.search"
                               class="w-full">
                    </div>
                </div>
                
                <!-- Tier Filter -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <span>Tier</span>
                        <button @click="toggleAllTiers()" x-text="allTiersSelected ? 'Limpar' : 'Todos'"></button>
                    </div>
                    <div class="tier-buttons">
                        <template x-for="tier in [4, 5, 6, 7, 8]" :key="tier">
                            <button @click="toggleTier(tier)"
                                    :class="filters.tiers.includes(tier) ? 'tier-btn active' : 'tier-btn'"
                                    :data-tier="tier"
                                    x-text="'T' + tier">
                            </button>
                        </template>
                    </div>
                </div>
                
                <!-- Category Filter -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <span>Categoria</span>
                        <button @click="toggleAllCategories()" x-text="allCategoriesSelected ? 'Limpar' : 'Todas'"></button>
                    </div>
                    <div>
                        <template x-for="cat in categories" :key="cat.id">
                            <label class="filter-item">
                                <input type="checkbox" 
                                       :checked="filters.categories.includes(cat.id)"
                                       @change="toggleCategory(cat.id)"
                                       class="custom-checkbox">
                                <span x-text="cat.name"></span>
                                <span class="filter-badge" x-text="getCategoryCount(cat.id)"></span>
                            </label>
                        </template>
                    </div>
                </div>
                
                <!-- Players Filter -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <span>Jogadores</span>
                        <span x-text="players.length + ' ativos'" style="font-weight: normal; text-transform: none;"></span>
                    </div>
                    <div class="player-list">
                        <template x-if="players.length === 0">
                            <p class="player-list-empty">Nenhum jogador detectado</p>
                        </template>
                        <template x-for="player in players" :key="player">
                            <label class="filter-item">
                                <input type="checkbox" 
                                       :checked="filters.players.includes(player)"
                                       @change="togglePlayer(player)"
                                       class="custom-checkbox">
                                <i data-lucide="user" class="w-4 h-4" style="color: var(--dark-400);"></i>
                                <span class="truncate" x-text="player"></span>
                                <span class="filter-badge" x-text="getPlayerLootCount(player)"></span>
                            </label>
                        </template>
                    </div>
                </div>
                
                <!-- Rare Only Toggle -->
                <div class="sidebar-section">
                    <label class="toggle">
                        <input type="checkbox" x-model="filters.rareOnly">
                        <span class="toggle-switch"></span>
                        <span class="toggle-label">Apenas Raros</span>
                    </label>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-stats">
                    <!-- Total Loots -->
                    <div class="stat-card">
                        <div class="stat-card-icon purple">
                            <i data-lucide="package"></i>
                        </div>
                        <div class="stat-card-content">
                            <p>Total Loots</p>
                            <p class="odometer" x-text="stats.total_loots.toLocaleString()">0</p>
                        </div>
                    </div>
                    
                    <!-- Total Items -->
                    <div class="stat-card">
                        <div class="stat-card-icon blue">
                            <i data-lucide="layers"></i>
                        </div>
                        <div class="stat-card-content">
                            <p>Total Itens</p>
                            <p class="odometer" x-text="stats.total_items.toLocaleString()">0</p>
                        </div>
                    </div>
                    
                    <!-- Players -->
                    <div class="stat-card">
                        <div class="stat-card-icon green">
                            <i data-lucide="users"></i>
                        </div>
                        <div class="stat-card-content">
                            <p>Players</p>
                            <p x-text="stats.players_active">0</p>
                        </div>
                    </div>
                    
                    <!-- Session Time -->
                    <div class="stat-card">
                        <div class="stat-card-icon amber">
                            <i data-lucide="clock"></i>
                        </div>
                        <div class="stat-card-content">
                            <p>Sessão</p>
                            <p class="font-mono" x-text="sessionTime">00:00:00</p>
                        </div>
                    </div>
                    
                    <!-- Silver Value -->
                    <div class="stat-card silver">
                        <div class="stat-card-icon amber">
                            <svg class="coin-icon-large" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" fill="url(#coinGrad)" stroke="#d97706" stroke-width="1.5"/>
                                <text x="12" y="16" text-anchor="middle" fill="#78350f" font-size="10" font-weight="bold" font-family="serif">S</text>
                                <defs>
                                    <linearGradient id="coinGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#fcd34d"/>
                                        <stop offset="100%" style="stop-color:#f59e0b"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <div class="stat-card-content">
                            <p style="color: rgba(234, 179, 8, 0.8);">Valor Estimado</p>
                            <p class="odometer" x-text="formatSilver(totalEstimatedValue)">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="header-actions">
                    <!-- Server Selector -->
                    <div class="server-selector">
                        <span class="server-selector-label">Servidor:</span>
                        <template x-for="server in priceServers" :key="server.id">
                            <button @click="changeServer(server.id)"
                                    :class="selectedServer === server.id ? 'server-btn active' : 'server-btn'"
                                    x-text="server.name">
                            </button>
                        </template>
                    </div>
                    
                    <!-- Discord Button -->
                    <button @click="openDiscordModal()" 
                            class="discord-btn"
                            :class="discordWebhook ? 'configured' : ''"
                            title="Configurar Discord Webhook">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                        </svg>
                    </button>
                    
                    <!-- Theme Switcher -->
                    <div class="theme-switcher" title="Trocar Tema">
                        <button @click="setTheme('purple')" 
                                class="theme-btn" 
                                :class="currentTheme === 'purple' ? 'active' : ''"
                                data-theme="purple"
                                title="Royal Purple">
                            <i data-lucide="palette"></i>
                        </button>
                        <button @click="setTheme('outlands')" 
                                class="theme-btn" 
                                :class="currentTheme === 'outlands' ? 'active' : ''"
                                data-theme="outlands"
                                title="Outlands Orange">
                            <i data-lucide="paintbrush"></i>
                        </button>
                    </div>
                    
                    <!-- Status Badges -->
                    <div class="status-badge" :class="statusClass">
                        <span class="dot"></span>
                        <span x-text="statusText"></span>
                    </div>
                    
                    <div class="status-badge" :class="connected ? 'online' : 'offline'">
                        <i data-lucide="wifi" class="w-3 h-3"></i>
                        <span x-text="connected ? 'Live' : 'Offline'"></span>
                    </div>
                    
                    <!-- Clear Button -->
                    <button @click="clearLoots()" class="btn btn-danger">
                        <i data-lucide="trash-2"></i>
                        Limpar
                    </button>
                </div>
            </header>
            
            <!-- Table Area -->
            <div class="content-area">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-header-title">
                            <h2>Loots Capturados</h2>
                            <span x-text="filteredLoots.length + ' itens'"></span>
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="loot-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Horário</th>
                                    <th style="width: 56px;" class="center">Item</th>
                                    <th>Nome</th>
                                    <th style="width: 56px;" class="center">Qtd</th>
                                    <th style="width: 64px;">Tier</th>
                                    <th style="width: 96px;" class="right">Valor</th>
                                    <th>Pegou</th>
                                    <th>Origem</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="loot in filteredLoots" :key="loot.id">
                                    <tr class="loot-row-new" :class="loot.tier.is_rare ? 'loot-row-rare' : ''">
                                        <td>
                                            <span class="timestamp" x-text="loot.timestamp_display"></span>
                                        </td>
                                        <td class="center">
                                            <div class="item-image-wrapper">
                                                <img :src="getItemImageUrl(loot.item_id)" 
                                                     :alt="loot.item_name"
                                                     class="item-image"
                                                     loading="lazy"
                                                     @error="$event.target.src = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2371717a%22 stroke-width=%222%22><path d=%22M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z%22/></svg>'">
                                                <div class="item-tooltip">
                                                    <img :src="getItemImageUrl(loot.item_id, 80)" :alt="loot.item_name">
                                                    <p class="item-tooltip-name" x-text="loot.item_name"></p>
                                                    <p class="item-tooltip-id" x-text="loot.item_id"></p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <span class="item-name" x-text="loot.item_name"></span>
                                                <template x-if="loot.tier.is_rare">
                                                    <span class="item-rare-badge">RARO</span>
                                                </template>
                                            </div>
                                            <span class="item-id" x-text="loot.item_id"></span>
                                        </td>
                                        <td class="center">
                                            <span class="quantity-badge" x-text="loot.quantity"></span>
                                        </td>
                                        <td>
                                            <span class="tier-display" 
                                                  :class="'tier-' + getTierFromDisplay(loot.tier.display) + ' ' + getEnchantClass(loot.tier.display)"
                                                  x-text="loot.tier.display || '-'"></span>
                                        </td>
                                        <td>
                                            <div class="silver-value">
                                                <template x-if="loot.estimatedPrice !== null">
                                                    <span class="silver-amount" 
                                                          x-text="loot.estimatedPrice > 0 ? formatSilver(loot.estimatedPrice * loot.quantity) : '-'"></span>
                                                </template>
                                                <template x-if="loot.estimatedPrice === null">
                                                    <span class="silver-loading">...</span>
                                                </template>
                                                <template x-if="loot.estimatedPrice > 0">
                                                    <svg class="silver-icon" viewBox="0 0 24 24" fill="none">
                                                        <circle cx="12" cy="12" r="10" fill="url(#coinGrad)" stroke="#d97706" stroke-width="1"/>
                                                        <text x="12" y="16" text-anchor="middle" fill="#78350f" font-size="10" font-weight="bold" font-family="serif">S</text>
                                                    </svg>
                                                </template>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="player-info">
                                                <div class="player-avatar">
                                                    <i data-lucide="user"></i>
                                                </div>
                                                <div>
                                                    <span class="player-name" x-text="loot.looted_by.name"></span>
                                                    <template x-if="loot.looted_by.guild">
                                                        <span class="player-guild" x-text="'[' + loot.looted_by.guild + ']'"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="origin-text" x-text="formatOrigin(loot.looted_from.name)"></span>
                                        </td>
                                    </tr>
                                </template>
                                
                                <!-- Empty State -->
                                <template x-if="filteredLoots.length === 0">
                                    <tr>
                                        <td colspan="8">
                                            <div class="table-empty">
                                                <div class="table-empty-icon">
                                                    <i data-lucide="package-open"></i>
                                                </div>
                                                <h3>Nenhum loot encontrado</h3>
                                                <p x-text="loots.length > 0 ? 'Tente ajustar os filtros' : 'Os loots aparecerão aqui em tempo real'"></p>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="footer">
                <div>
                    <span>Loot Logger Dashboard</span>
                    <span>•</span>
                    <span>Open Source by <a href="https://github.com/Kazxye" target="_blank">Kazz</a></span>
                </div>
                <div class="font-mono">
                    ws://127.0.0.1:5000
                </div>
            </footer>
        </main>
        
        <!-- Discord Webhook Modal -->
        <div class="modal-backdrop" x-show="discordModalOpen" x-cloak @click.self="closeDiscordModal()">
            <div class="modal">
                <div class="modal-header">
                    <h3>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                        </svg>
                        Discord Webhook
                    </h3>
                    <button @click="closeDiscordModal()" class="modal-close">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <label for="webhook-url">URL do Webhook</label>
                    <input type="text" 
                           id="webhook-url"
                           x-model="discordWebhook" 
                           placeholder="https://discord.com/api/webhooks/..."
                           @keyup.enter="saveDiscordWebhook()">
                    <p class="hint">Itens raros e de alto valor serão enviados automaticamente para o Discord.</p>
                </div>
                <div class="modal-footer">
                    <template x-if="discordTestResult">
                        <div class="modal-result" :class="discordTestResult.success ? 'success' : 'error'"
                             x-text="discordTestResult.message"></div>
                    </template>
                    <button @click="testDiscordWebhook()" 
                            class="btn btn-discord"
                            :disabled="discordTesting || !discordWebhook">
                        <template x-if="discordTesting">
                            <span class="spinner" style="width: 16px; height: 16px;"></span>
                        </template>
                        <template x-if="!discordTesting">
                            <span>Testar</span>
                        </template>
                    </button>
                    <button @click="saveDiscordWebhook()" class="btn btn-primary">
                        Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/splash.js') }}"></script>
</body>
</html>
